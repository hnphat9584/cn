<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Process Manager</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
            margin-top: 0;
        }
        h2 {
            color: #666;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-weight: bold;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
        }
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        button.danger {
            background: #dc3545;
        }
        button.danger:hover {
            background: #c82333;
        }
        input[type="text"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 300px;
            margin-right: 10px;
        }
        #output {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
        }
        tr:hover {
            background: #f8f9fa;
        }
        .process-list, .app-list {
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>üîå WebSocket Process Manager</h1>
    
    <div class="container">
        <h2>Connection</h2>
        <div id="status" class="status disconnected">Disconnected</div>
        <div style="margin: 10px 0;">
            <label for="serverIp" style="display: block; margin-bottom: 5px; font-weight: bold;">Server IP Address:</label>
            <input type="text" id="serverIp" placeholder="192.168.1.100" style="width: 200px; padding: 8px; margin-right: 10px;">
            <label for="serverPort" style="font-weight: bold;">Port:</label>
            <input type="text" id="serverPort" value="8080" style="width: 80px; padding: 8px;">
            <button onclick="scanNetwork()" style="background: #28a745; margin-left: 10px;">üîç Scan Network</button>
        </div>
        <div id="scanResults" style="display: none; background: #f8f9fa; border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 4px;">
            <strong>Available Servers:</strong>
            <div id="serverList" style="margin-top: 10px;"></div>
        </div>
        <button id="connectBtn" onclick="connect()">Connect to Server</button>
        <button id="disconnectBtn" onclick="disconnect()" disabled>Disconnect</button>
        <div style="background: #e7f3ff; border: 1px solid #2196F3; padding: 10px; margin: 10px 0; border-radius: 4px; font-size: 13px;">
            ‚ÑπÔ∏è <strong>How to connect:</strong>
            <ol style="margin: 5px 0 0 20px; padding: 0;">
                <li>Click "üîç Scan Network" to find available servers automatically</li>
                <li>Or manually enter the server IP address shown by websocket_server.exe</li>
                <li>Click "Connect to Server"</li>
                <li>Make sure both devices are on the same network</li>
            </ol>
        </div>
    </div>

    <div class="container">
        <h2>Process Control</h2>
        <button onclick="listProcesses()">Refresh Process List</button>
        <div style="margin-top: 10px;">
            <input type="text" id="processPath" placeholder="Enter process path (e.g., notepad.exe or C:\path\to\app.exe)">
            <button onclick="startProcessDirect()">Start Process</button>
        </div>
        <p style="color: #666; font-size: 14px; margin-top: 10px;">Click "Kill" button next to any process to terminate it</p>
        <div class="process-list" id="processList"></div>
    </div>

    <div class="container">
        <h2>Application Control</h2>
        <button onclick="listApplications()">List Applications</button>
        <div style="margin-top: 10px;">
            <input type="text" id="appSearch" placeholder="Search applications..." onkeyup="filterApplications()">
        </div>
        <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 10px; margin: 10px 0; border-radius: 4px; font-size: 14px;">
            ‚ÑπÔ∏è <strong>Note:</strong> Apps marked "N/A" are either Windows Store apps (UWP) or their executable couldn't be found. 
            You can launch these apps from the Windows Start Menu or use the Process Control section to start them by name (e.g., "calculator:", "ms-settings:").
        </div>
        <div class="app-list" id="appList"></div>
    </div>

    <div class="container">
        <h2>Console Output</h2>
        <button onclick="clearOutput()">Clear</button>
        <div id="output"></div>
    </div>

    <script>
        let ws = null;

        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
            output.innerHTML += `[${timestamp}] ${prefix} ${message}\n`;
            output.scrollTop = output.scrollHeight;
        }

        function updateStatus(connected, url) {
            const status = document.getElementById('status');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            
            if (connected) {
                status.textContent = 'Connected to ' + url;
                status.className = 'status connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                status.textContent = 'Disconnected';
                status.className = 'status disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }

        function connect() {
            if (ws) return;
            
            const serverIp = document.getElementById('serverIp').value.trim();
            const serverPort = document.getElementById('serverPort').value.trim();
            
            if (!serverIp) {
                alert('Please enter the server IP address!');
                document.getElementById('serverIp').focus();
                return;
            }
            
            const wsUrl = `ws://${serverIp}:${serverPort}`;
            log(`Connecting to ${wsUrl}...`);
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                log('Connected successfully!', 'success');
                updateStatus(true, wsUrl);
            };
            
            ws.onmessage = (event) => {
                log('Received: ' + event.data);
                try {
                    const data = JSON.parse(event.data);
                    log('Parsed data: ' + JSON.stringify(data).substring(0, 200) + '...');
                    handleResponse(data);
                } catch (e) {
                    log('Failed to parse response: ' + e.message, 'error');
                }
            };
            
            ws.onerror = (error) => {
                log('WebSocket error occurred - Check if server is running and IP is correct', 'error');
            };
            
            ws.onclose = () => {
                log('Connection closed', 'error');
                updateStatus(false);
                ws = null;
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function send(command) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('Not connected to server!', 'error');
                return;
            }
            log('Sending: ' + command);
            ws.send(command);
        }

        function listProcesses() {
            send('list_processes');
        }

        function listApplications() {
            send('list_applications');
        }

        function stopProcess() {
            const pid = document.getElementById('pidInput').value;
            if (!pid) {
                alert('Please enter a PID');
                return;
            }
            send('stop_process:' + pid);
        }

        function startProcessDirect() {
            const path = document.getElementById('processPath').value;
            if (!path) {
                alert('Please enter a process path');
                return;
            }
            send('start_process:' + path);
        }

        function handleResponse(data) {
            log('Handling response type: ' + (Array.isArray(data) ? 'Array' : typeof data));
            
            if (Array.isArray(data)) {
                log('Array length: ' + data.length);
                if (data.length > 0) {
                    log('First item keys: ' + Object.keys(data[0]).join(', '));
                    
                    if (data[0].pid !== undefined) {
                        log('Detected as process list');
                        displayProcesses(data);
                    } else if (data[0].exe !== undefined || data[0].path !== undefined || data[0].name !== undefined) {
                        log('Detected as application list');
                        displayApplications(data);
                    } else {
                        log('Unknown array type', 'error');
                    }
                } else {
                    log('Empty array received', 'error');
                }
            } else if (data.status) {
                if (data.status === 'success') {
                    log('Operation successful: ' + JSON.stringify(data), 'success');
                } else {
                    log('Operation failed: ' + data.message, 'error');
                }
            } else {
                log('Unknown response format', 'error');
            }
        }

        function displayProcesses(processes) {
            const list = document.getElementById('processList');
            
            if (!processes || processes.length === 0) {
                list.innerHTML = '<p style="color: #999;">No processes found</p>';
                return;
            }
            
            let html = '<table><tr><th>PID</th><th>Process Name</th><th>Action</th></tr>';
            
            processes.forEach(proc => {
                html += `<tr>
                    <td><strong>${proc.pid}</strong></td>
                    <td>${proc.name}</td>
                    <td><button class="danger" onclick="killProcess(${proc.pid}, '${proc.name}')">Kill</button></td>
                </tr>`;
            });
            
            html += '</table>';
            list.innerHTML = html;
            log(`Displayed ${processes.length} processes`, 'success');
        }

        function killProcess(pid, name) {
            if (confirm(`Are you sure you want to kill "${name}" (PID: ${pid})?`)) {
                send('stop_process:' + pid);
                log(`Attempting to kill ${name} (PID: ${pid})...`);
            }
        }

        function displayApplications(apps) {
            log('displayApplications called with ' + apps.length + ' items');
            const list = document.getElementById('appList');
            
            if (!list) {
                log('ERROR: appList element not found!', 'error');
                return;
            }
            
            if (!apps || apps.length === 0) {
                list.innerHTML = '<p style="color: #999; padding: 20px;">No applications found. The scan might take a moment...</p>';
                log('No applications to display', 'error');
                return;
            }
            
            allApps = apps; // Store for filtering
            
            // Count launchable vs non-launchable
            const launchable = apps.filter(app => app.exe !== 'N/A' && app.path).length;
            const total = apps.length;
            
            let html = `<p style="color: #666; font-size: 14px; margin-bottom: 10px;">
                Showing ${total} applications (${launchable} launchable via this tool, ${total - launchable} require Windows Store/Start Menu)
            </p>`;
            
            html += '<table><tr><th>Application</th><th>Publisher</th><th>Executable</th><th>Status</th><th>Action</th></tr>';
            
            apps.forEach((app, index) => {
                log(`App ${index}: ${JSON.stringify(app)}`);
                const appName = app.name || 'Unknown';
                const publisher = app.publisher || '';
                const exeName = app.exe || 'N/A';
                const fullPath = app.path || '';
                
                const canLaunch = exeName !== 'N/A' && fullPath !== '';
                const statusIcon = canLaunch ? '‚úÖ' : '‚ö†Ô∏è';
                const statusText = canLaunch ? 'Ready' : 'UWP/Store App';
                
                html += `<tr>
                    <td><strong>${appName}</strong></td>
                    <td style="font-size: 11px; color: #666;">${publisher}</td>
                    <td style="font-size: 11px;">${exeName}</td>
                    <td style="font-size: 12px;">${statusIcon} ${statusText}</td>
                    <td>${canLaunch ? `<button onclick="launchApp('${fullPath.replace(/\\/g, '\\\\').replace(/'/g, "\\'")}')">Launch</button>` : '<span style="color: #999;">Use Start Menu</span>'}</td>
                </tr>`;
            });
            
            html += '</table>';
            list.innerHTML = html;
            log(`SUCCESS: Displayed ${apps.length} applications (${launchable} launchable)`, 'success');
        }

        function launchApp(path) {
            send('start_process:' + path);
            log(`Launching: ${path}`);
        }

        let allApps = [];

        function filterApplications() {
            const searchTerm = document.getElementById('appSearch').value.toLowerCase();
            const filtered = allApps.filter(app => 
                app.name.toLowerCase().includes(searchTerm) || 
                (app.exe && app.exe.toLowerCase().includes(searchTerm)) ||
                (app.publisher && app.publisher.toLowerCase().includes(searchTerm))
            );
            displayApplicationsFiltered(filtered);
        }

        function displayApplicationsFiltered(apps) {
            const list = document.getElementById('appList');
            
            if (!apps || apps.length === 0) {
                list.innerHTML = '<p style="color: #999; padding: 20px;">No applications match your search.</p>';
                return;
            }
            
            let html = '<table><tr><th>Application</th><th>Publisher</th><th>Executable</th><th>Status</th><th>Action</th></tr>';
            
            apps.forEach((app) => {
                const appName = app.name || 'Unknown';
                const publisher = app.publisher || '';
                const exeName = app.exe || 'N/A';
                const fullPath = app.path || '';
                
                const canLaunch = exeName !== 'N/A' && fullPath !== '';
                const statusIcon = canLaunch ? '‚úÖ' : '‚ö†Ô∏è';
                const statusText = canLaunch ? 'Ready' : 'UWP/Store App';
                
                html += `<tr>
                    <td><strong>${appName}</strong></td>
                    <td style="font-size: 11px; color: #666;">${publisher}</td>
                    <td style="font-size: 11px;">${exeName}</td>
                    <td style="font-size: 12px;">${statusIcon} ${statusText}</td>
                    <td>${canLaunch ? `<button onclick="launchApp('${fullPath.replace(/\\/g, '\\\\').replace(/'/g, "\\'")}')">Launch</button>` : '<span style="color: #999;">Use Start Menu</span>'}</td>
                </tr>`;
            });
            
            html += '</table>';
            list.innerHTML = html;
        }

        function clearOutput() {
            document.getElementById('output').innerHTML = '';
        }

        // Remove auto-connect on load
        window.onload = () => {
            log('Page loaded. Enter server IP address and click "Connect to Server".');
        };

        // Network scanning function
        async function scanNetwork() {
            const scanResults = document.getElementById('scanResults');
            const serverList = document.getElementById('serverList');
            const port = document.getElementById('serverPort').value || '8080';
            
            scanResults.style.display = 'block';
            serverList.innerHTML = '<p style="color: #666;">üîç Scanning network for servers on port ' + port + '... This may take a moment.</p>';
            log('Starting network scan on port ' + port + '...');
            
            // Get common local IP ranges
            const ipRanges = [];
            
            // Try to detect current network from WebRTC
            try {
                const pc = new RTCPeerConnection({iceServers: []});
                pc.createDataChannel('');
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                
                await new Promise(resolve => {
                    pc.onicecandidate = (event) => {
                        if (event.candidate) {
                            const candidate = event.candidate.candidate;
                            const ipMatch = candidate.match(/(\d+\.\d+\.\d+)\.\d+/);
                            if (ipMatch && ipMatch[1]) {
                                const subnet = ipMatch[1];
                                if (!ipRanges.includes(subnet)) {
                                    ipRanges.push(subnet);
                                    log('Detected subnet: ' + subnet + '.x');
                                }
                            }
                        } else {
                            resolve();
                        }
                    };
                    setTimeout(resolve, 2000); // Timeout after 2 seconds
                });
                pc.close();
            } catch (e) {
                log('WebRTC detection failed, using common ranges', 'error');
            }
            
            // Add common private IP ranges if none detected
            if (ipRanges.length === 0) {
                ipRanges.push('192.168.1', '192.168.0', '192.168.2', '10.0.0', '172.16.0');
                log('Using default IP ranges: ' + ipRanges.join(', '));
            }
            
            // Also check localhost
            ipRanges.push('127.0.0');
            
            const foundServers = [];
            const promises = [];
            let scannedCount = 0;
            let totalIps = 0;
            
            // Scan each subnet
            for (const subnet of ipRanges) {
                // Scan common IPs: .1, .100-110, .150-160, .200-210
                const ipsToScan = [
                    1, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110,
                    150, 151, 152, 153, 154, 155, 156, 157, 158, 159, 160,
                    200, 201, 202, 203, 204, 205, 206, 207, 208, 209, 210
                ];
                
                totalIps += ipsToScan.length;
                
                for (const lastOctet of ipsToScan) {
                    const ip = `${subnet}.${lastOctet}`;
                    
                    promises.push(
                        (async () => {
                            try {
                                log(`Trying ${ip}:${port}...`);
                                const testWs = new WebSocket(`ws://${ip}:${port}`);
                                
                                await new Promise((resolve, reject) => {
                                    const timeout = setTimeout(() => {
                                        testWs.close();
                                        reject(new Error('timeout'));
                                    }, 2000); // Increased to 2 seconds
                                    
                                    testWs.onopen = () => {
                                        clearTimeout(timeout);
                                        foundServers.push(ip);
                                        log(`‚úÖ Found server at ${ip}:${port}`, 'success');
                                        testWs.close();
                                        resolve();
                                    };
                                    
                                    testWs.onerror = () => {
                                        clearTimeout(timeout);
                                        testWs.close();
                                        reject(new Error('connection failed'));
                                    };
                                });
                            } catch (e) {
                                // Connection failed, ignore
                            } finally {
                                scannedCount++;
                                if (scannedCount % 10 === 0) {
                                    serverList.innerHTML = `<p style="color: #666;">üîç Scanning... ${scannedCount}/${totalIps} IPs checked</p>`;
                                }
                            }
                        })()
                    );
                }
            }
            
            // Wait for all scans to complete
            await Promise.allSettled(promises);
            
            if (foundServers.length > 0) {
                let html = '<p style="color: #28a745; font-weight: bold;">‚úÖ Found ' + foundServers.length + ' server(s):</p>';
                foundServers.forEach(ip => {
                    html += `<div style="padding: 8px; margin: 5px 0; background: white; border: 1px solid #ddd; border-radius: 4px;">
                        <strong>${ip}:${port}</strong>
                        <button onclick="selectServer('${ip}')" style="float: right; padding: 5px 15px;">Select</button>
                    </div>`;
                });
                serverList.innerHTML = html;
                log(`Scan complete: Found ${foundServers.length} server(s)`, 'success');
            } else {
                serverList.innerHTML = `<p style="color: #dc3545;">‚ùå No servers found on ${totalIps} IPs checked.</p>
                    <p style="color: #666; font-size: 13px;">Troubleshooting:</p>
                    <ul style="font-size: 13px; color: #666;">
                        <li>Make sure websocket_server.exe is running</li>
                        <li>Check Windows Firewall (allow port ${port})</li>
                        <li>Try manually entering the IP shown by the server</li>
                        <li>Check Console Output below for scan details</li>
                    </ul>`;
                log('Scan complete: No servers found. Check firewall and server status.', 'error');
            }
        }

        function selectServer(ip) {
            document.getElementById('serverIp').value = ip;
            log('Selected server: ' + ip);
        }
    </script>
</body>
</html>